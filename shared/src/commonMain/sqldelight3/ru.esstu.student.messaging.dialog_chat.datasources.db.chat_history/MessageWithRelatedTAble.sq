
import ru.esstu.student.messaging.dialog_chat.datasources.db.chat_history.entities.DialogChatAuthorEntity;



CREATE TABLE DialogChatMessageTable(
    messageId INTEGER PRIMARY KEY,
    appUserId TEXT NOT NULL,
    opponentId TEXT,
    fromSend TEXT AS DialogChatAuthorEntity NOT NULL,
    replyMessageId INTEGER,
    date INTEGER NOT NULL,
    message TEXT,
    status TEXT
);

CREATE TABLE DialogChatAttachmentTable(
    idAttachment INTEGER PRIMARY KEY NOT NULL,
    messageId INTEGER NOT NULL ,
    fileUri TEXT,
    LocalFileUri TEXT,
    loadProgress REAL,
    name TEXT,
    ext TEXT,
    size INTEGER NOT NULL,
    type TEXT
);

CREATE TABLE DialogChatReplyMessageTable(
    idReplyMessage INTEGER PRIMARY KEY,
    fromSendReplyMessage TEXT AS DialogChatAuthorEntity,
    dateReplyMessage INTEGER,
    messageReplayMessage TEXT,
    attachmentsCount INTEGER
);

getReplyMessage:
     SELECT t.*, o.*
            FROM DialogChatMessageTable t
            LEFT JOIN DialogChatAttachmentTable o ON t.messageId == o.messageId
            WHERE t.appUserId == (:appUserId) AND t.opponentId == (:opponentId);

test:
    SELECT  * FROM  DialogChatMessageTable;

insertMessage:
    INSERT OR REPLACE INTO DialogChatMessageTable(messageId, opponentId, fromSend,replyMessageId,date,message,status, appUserId)
        VALUES(?, ?, ?, ?, ?, ?, ?, ?);

insertAttachments:
    INSERT OR REPLACE INTO DialogChatAttachmentTable(idAttachment, messageId, fileUri,LocalFileUri,name,ext,size, type)
        VALUES(?, ?, ?, ?, ?, ?, ?, ?);

clearAttachments:
    DELETE FROM DialogChatAttachmentTable WHERE messageId == (:messageId);


insertReply:
    INSERT OR REPLACE INTO DialogChatReplyMessageTable(idReplyMessage, fromSendReplyMessage, dateReplyMessage,messageReplayMessage,attachmentsCount)
        VALUES(?, ?, ?, ?, ?);

getMessageHistory:
    SELECT t.*, o.*, q.*
        FROM DialogChatMessageTable t
        LEFT JOIN DialogChatAttachmentTable o ON t.messageId == o.messageId
        LEFT JOIN DialogChatReplyMessageTable q ON t.replyMessageId == q.idReplyMessage
        WHERE t.appUserId == (:appUserId) AND t.opponentId == (:opponentId)
        ORDER BY date DESC LIMIT (:limit) OFFSET (:offset);